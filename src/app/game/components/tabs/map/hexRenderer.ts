import { HexTile, Unit, City } from '@/types/game';
import { calculateHexPosition } from './hexUtils';

// Ï∫îÎ≤ÑÏä§ Ïª®ÌÖçÏä§Ìä∏ ÌÉÄÏûÖ Ï†ïÏùò
type CanvasContext = CanvasRenderingContext2D;
type Position = { x: number, y: number };

// Ïú°Í∞ÅÌòï Í∑∏Î¶¨Îìú Í∑∏Î¶¨Í∏∞
export const drawHexGrid = (
  ctx: CanvasContext, 
  hexagons: HexTile[], 
  offset: { x: number, y: number }, 
  scale: number
) => {
  ctx.save();
  ctx.translate(offset.x, offset.y);
  
  // Í∑∏Î¶¨Îìú ÎùºÏù∏ Ïä§ÌÉÄÏùº ÏÑ§Ï†ï
  ctx.strokeStyle = 'rgba(100, 100, 100, 0.3)';
  ctx.lineWidth = 0.5 * scale;
  
  // Î™®Îì† Ïú°Í∞ÅÌòï ÌÉÄÏùº Í∑∏Î¶¨Í∏∞
  hexagons.forEach(hex => {
    const { x, y } = calculateHexPosition(hex.q, hex.r, { x: 0, y: 0 }, scale);
    
    // Ïú°Í∞ÅÌòï Í≤ΩÎ°ú Í∑∏Î¶¨Í∏∞
    ctx.beginPath();
    for (let i = 0; i < 6; i++) {
      const angle = (i * Math.PI) / 3;
      const px = x + Math.cos(angle) * 30 * scale;
      const py = y + Math.sin(angle) * 30 * scale;
      
      if (i === 0) {
        ctx.moveTo(px, py);
      } else {
        ctx.lineTo(px, py);
      }
    }
    ctx.closePath();
    ctx.stroke();
  });
  
  ctx.restore();
};

// Ïú°Í∞ÅÌòï ÌÉÄÏùº Í∑∏Î¶¨Í∏∞
export const drawHexTile = (
  ctx: CanvasContext, 
  tile: HexTile, 
  position: { x: number, y: number }, 
  scale: number,
  isSelected: boolean,
  isHovered: boolean = false
) => {
  const { x, y } = position;
  
  // Ïú°Í∞ÅÌòï Í≤ΩÎ°ú ÏÉùÏÑ±
  ctx.beginPath();
  for (let i = 0; i < 6; i++) {
    const angle = (i * Math.PI) / 3;
    const px = x + Math.cos(angle) * 30 * scale;
    const py = y + Math.sin(angle) * 30 * scale;
    
    if (i === 0) {
      ctx.moveTo(px, py);
    } else {
      ctx.lineTo(px, py);
    }
  }
  ctx.closePath();
  
  // ÌÉêÌóò ÏÉÅÌÉúÏóê Îî∞Î•∏ ÌÉÄÏùº Î†åÎçîÎßÅ
  if (tile.exploration === 'unexplored') {
    // ÎØ∏ÌÉêÏÉâ ÏßÄÏó≠ - Í≤ÄÏùÄÏÉâÏúºÎ°ú ÌëúÏãú
    ctx.fillStyle = '#000000';
    ctx.fill();
    
    // ÌÖåÎëêÎ¶¨
    ctx.strokeStyle = 'rgba(50, 50, 50, 0.5)';
    ctx.lineWidth = 0.5 * scale;
    ctx.stroke();
    
    return; // ÎØ∏ÌÉêÏÉâ ÏßÄÏó≠ÏùÄ Ïó¨Í∏∞ÏóêÏÑú Î†åÎçîÎßÅ Ï¢ÖÎ£å
  }
  
  // ÏßÄÌòïÏóê Îî∞Î•∏ ÏÉâÏÉÅ ÏÑ§Ï†ï
  let fillColor = '#8B8B8B'; // Í∏∞Î≥∏ ÏÉâÏÉÅ
  
  switch (tile.terrain) {
    case 'Plains':
    case 'plains':
      fillColor = '#A9D751'; // ÌèâÏßÄ
      break;
    case 'Grassland':
    case 'grassland':
      fillColor = '#7ABD3E'; // Ï¥àÏõê
      break;
    case 'Desert':
    case 'desert':
      fillColor = '#E6C35C'; // ÏÇ¨Îßâ
      break;
    case 'Mountain':
    case 'mountain':
      fillColor = '#8B8B8B'; // ÏÇ∞ÏïÖ
      break;
    case 'Hills':
    case 'hills':
      fillColor = '#A0522D'; // Ïñ∏Îçï
      break;
    case 'Forest':
    case 'forest':
      fillColor = '#2E8B57'; // Ïà≤
      break;
    case 'Ocean':
    case 'ocean':
      fillColor = '#1E90FF'; // Î∞îÎã§
      break;
    case 'Coast':
    case 'coast':
      fillColor = '#87CEEB'; // Ìï¥Ïïà
      break;
  }
  
  // ÌÉêÌóò ÏÉÅÌÉúÏóê Îî∞Î•∏ ÏÉâÏÉÅ Ï≤òÎ¶¨
  if (tile.exploration === 'explored') {
    // ÌÉêÏÉâÌñàÏßÄÎßå ÌòÑÏû¨ ÏãúÏïºÏóêÎäî ÏóÜÎäî ÏßÄÏó≠ - ÌöåÏÉâÏúºÎ°ú Ïñ¥Îë°Í≤å ÌëúÏãú
    fillColor = darkenColor(fillColor, 40);
  }
  
  // ÌÉÄÏùº Ï±ÑÏö∞Í∏∞ - Ìò∏Î≤Ñ/ÏÑ†ÌÉù Ïãú Î∞ùÍ≤å ÌëúÏãú
  if (isHovered) {
    // Ìò∏Î≤Ñ ÏÉÅÌÉú: ÏïΩÍ∞Ñ Î∞ùÍ≤å
    ctx.fillStyle = lightenColor(fillColor, 20);
  } else if (isSelected) {
    // ÏÑ†ÌÉù ÏÉÅÌÉú: Îçî Î∞ùÍ≤å
    ctx.fillStyle = lightenColor(fillColor, 40);
  } else {
    ctx.fillStyle = fillColor;
  }
  ctx.fill();
  
  // ÌÖåÎëêÎ¶¨ Í∑∏Î¶¨Í∏∞
  if (isSelected) {
    ctx.strokeStyle = '#FFFF00'; // ÎÖ∏ÎûÄÏÉâ ÌÖåÎëêÎ¶¨
    ctx.lineWidth = 2 * scale;
  } else if (isHovered) {
    ctx.strokeStyle = '#FFFFFF'; // Ìù∞ÏÉâ ÌÖåÎëêÎ¶¨
    ctx.lineWidth = 1.5 * scale;
  } else {
    ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
    ctx.lineWidth = 1 * scale;
  }
  ctx.stroke();
  
  // ÏûêÏõê ÌëúÏãú (ÏûàÎäî Í≤ΩÏö∞ & ÏãúÏïºÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
  if (tile.resource && tile.resource !== 'NoResource' && tile.exploration === 'visible') {
    ctx.fillStyle = '#FFFFFF';
    ctx.font = `${12 * scale}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // ÏûêÏõê ÏïÑÏù¥ÏΩò
    let resourceIcon = 'üíé';
    switch (tile.resource) {
      case 'Food':
      case 'food':
        resourceIcon = 'üåΩ';
        break;
      case 'Production':
      case 'production':
        resourceIcon = '‚öíÔ∏è';
        break;
      case 'Gold':
      case 'gold':
        resourceIcon = 'üí∞';
        break;
      case 'Science':
      case 'science':
        resourceIcon = 'üî¨';
        break;
    }
    
    ctx.fillText(resourceIcon, x, y);
  }
};

// ÏÉâÏÉÅ Î∞ùÍ≤å ÎßåÎìúÎäî Ìï®Ïàò
function lightenColor(color: string, amount: number): string {
  // ÏÉâÏÉÅÏù¥ RGB Ìè¨Îß∑Ïù¥ÎùºÎ©¥ (Ïòà: #8B8B8B)
  if (color.startsWith('#')) {
    let r = parseInt(color.slice(1, 3), 16);
    let g = parseInt(color.slice(3, 5), 16);
    let b = parseInt(color.slice(5, 7), 16);
    
    r = Math.min(255, r + amount);
    g = Math.min(255, g + amount);
    b = Math.min(255, b + amount);
    
    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
  }
  
  // ÏÉâÏÉÅÏù¥ rgba Ìè¨Îß∑Ïù¥ÎùºÎ©¥
  if (color.startsWith('rgba')) {
    const rgbaMatch = color.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
    if (rgbaMatch) {
      const r = Math.min(255, parseInt(rgbaMatch[1]) + amount);
      const g = Math.min(255, parseInt(rgbaMatch[2]) + amount);
      const b = Math.min(255, parseInt(rgbaMatch[3]) + amount);
      const a = rgbaMatch[4];
      
      return `rgba(${r}, ${g}, ${b}, ${a})`;
    }
  }
  
  // Îã§Î•∏ Ìè¨Îß∑Ïù¥Í±∞ÎÇò Î≥ÄÌôòÏù¥ Ïã§Ìå®ÌïòÎ©¥ ÏõêÎûò ÏÉâÏÉÅ Î∞òÌôò
  return color;
}

// ÏÉâÏÉÅ Ïñ¥Îë°Í≤å ÎßåÎìúÎäî Ìï®Ïàò
function darkenColor(color: string, amount: number): string {
  // ÏÉâÏÉÅÏù¥ RGB Ìè¨Îß∑Ïù¥ÎùºÎ©¥ (Ïòà: #8B8B8B)
  if (color.startsWith('#')) {
    let r = parseInt(color.slice(1, 3), 16);
    let g = parseInt(color.slice(3, 5), 16);
    let b = parseInt(color.slice(5, 7), 16);
    
    r = Math.max(0, r - amount);
    g = Math.max(0, g - amount);
    b = Math.max(0, b - amount);
    
    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
  }
  
  // ÏÉâÏÉÅÏù¥ rgba Ìè¨Îß∑Ïù¥ÎùºÎ©¥
  if (color.startsWith('rgba')) {
    const rgbaMatch = color.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
    if (rgbaMatch) {
      const r = Math.max(0, parseInt(rgbaMatch[1]) - amount);
      const g = Math.max(0, parseInt(rgbaMatch[2]) - amount);
      const b = Math.max(0, parseInt(rgbaMatch[3]) - amount);
      const a = rgbaMatch[4];
      
      return `rgba(${r}, ${g}, ${b}, ${a})`;
    }
  }
  
  // Îã§Î•∏ Ìè¨Îß∑Ïù¥Í±∞ÎÇò Î≥ÄÌôòÏù¥ Ïã§Ìå®ÌïòÎ©¥ ÏõêÎûò ÏÉâÏÉÅ Î∞òÌôò
  return color;
}

// Ïú†Îãõ Í∑∏Î¶¨Í∏∞
export const drawUnit = (
  ctx: CanvasContext, 
  unit: Unit, 
  position: { x: number, y: number }, 
  scale: number
) => {
  const { x, y } = position;
  
  // Ïú†Îãõ Ïõê Í∑∏Î¶¨Í∏∞
  ctx.beginPath();
  ctx.arc(x, y, 15, 0, Math.PI * 2);
  
  // Ïú†Îãõ ÏÜåÏú†ÏûêÏóê Îî∞Î•∏ ÏÉâÏÉÅ ÏÑ§Ï†ï
  let fillColor = '#FFFFFF'; // Í∏∞Î≥∏ ÏÉâÏÉÅ
  
  switch (unit.owner) {
    case 'player':
      fillColor = '#3498DB'; // ÌîåÎ†àÏù¥Ïñ¥
      break;
    case 'enemy':
      fillColor = '#E74C3C'; // Ï†Å
      break;
    case 'neutral':
      fillColor = '#95A5A6'; // Ï§ëÎ¶Ω
      break;
  }
  
  ctx.fillStyle = fillColor;
  ctx.fill();
  ctx.strokeStyle = '#000000';
  ctx.lineWidth = 1;
  ctx.stroke();
  
  // Ïú†Îãõ ÏïÑÏù¥ÏΩò ÎòêÎäî Î¨∏Ïûê ÌëúÏãú
  ctx.fillStyle = '#FFFFFF';
  ctx.font = '12px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  
  // Ïú†Îãõ ÌÉÄÏûÖÏóê Îî∞Î•∏ ÏïÑÏù¥ÏΩò
  let icon = '?';
  switch (unit.type) {
    case 'military':
      icon = '‚öîÔ∏è';
      break;
    case 'worker':
      icon = 'üî®';
      break;
    case 'settler':
      icon = 'üè†';
      break;
  }
  
  ctx.fillText(icon, x, y);
};

// ÎèÑÏãú Í∑∏Î¶¨Í∏∞
export const drawCity = (
  ctx: CanvasContext, 
  city: { name: string; owner: string; population?: number; id?: number }, 
  position: { x: number, y: number }, 
  scale: number
) => {
  const { x, y } = position;
  
  // ÎèÑÏãú ÏïÑÏù¥ÏΩò Í∑∏Î¶¨Í∏∞ (Í±¥Î¨º Î™®Ïñë)
  ctx.beginPath();
  ctx.moveTo(x, y - 20 * scale);
  ctx.lineTo(x + 15 * scale, y + 10 * scale);
  ctx.lineTo(x - 15 * scale, y + 10 * scale);
  ctx.closePath();
  
  // ÎèÑÏãú ÏÜåÏú†ÏûêÏóê Îî∞Î•∏ ÏÉâÏÉÅ ÏÑ§Ï†ï
  let fillColor = '#FFFFFF'; // Í∏∞Î≥∏ ÏÉâÏÉÅ
  
  switch (city.owner) {
    case 'player':
      fillColor = '#3498DB'; // ÌîåÎ†àÏù¥Ïñ¥
      break;
    case 'enemy':
      fillColor = '#E74C3C'; // Ï†Å
      break;
    case 'neutral':
      fillColor = '#95A5A6'; // Ï§ëÎ¶Ω
      break;
  }
  
  ctx.fillStyle = fillColor;
  ctx.fill();
  ctx.strokeStyle = '#000000';
  ctx.lineWidth = 1;
  ctx.stroke();
  
  // ÎèÑÏãú Ïù¥Î¶Ñ ÌëúÏãú
  ctx.fillStyle = '#FFFFFF';
  ctx.font = `${12 * scale}px Arial`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(city.name, x, y + 25 * scale);
  
  // Ïù∏Íµ¨ ÌëúÏãú
  if (city.population) {
    ctx.fillStyle = '#FFFFFF';
    ctx.font = `${8 * scale}px Arial`;
    ctx.fillText(`Ïù∏Íµ¨: ${city.population}`, x, y + 35 * scale);
  }
};

// Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
const getHexPoints = (q: number, r: number, offset: Position, scale: number): Position[] => {
  const size = 30 * scale;
  const x = offset.x + size * (Math.sqrt(3) * q + Math.sqrt(3) / 2 * r);
  const y = offset.y + size * (3/2 * r);

  return [
    { x: x + size * Math.cos(0), y: y + size * Math.sin(0) },
    { x: x + size * Math.cos(Math.PI / 3), y: y + size * Math.sin(Math.PI / 3) },
    { x: x + size * Math.cos(2 * Math.PI / 3), y: y + size * Math.sin(2 * Math.PI / 3) },
    { x: x + size * Math.cos(Math.PI), y: y + size * Math.sin(Math.PI) },
    { x: x + size * Math.cos(4 * Math.PI / 3), y: y + size * Math.sin(4 * Math.PI / 3) },
    { x: x + size * Math.cos(5 * Math.PI / 3), y: y + size * Math.sin(5 * Math.PI / 3) }
  ];
};

const getTerrainColor = (terrain: string): string => {
  const colors: { [key: string]: string } = {
    plains: '#90EE90',
    grassland: '#32CD32',
    desert: '#F4A460',
    tundra: '#E0FFFF',
    snow: '#FFFFFF',
    ocean: '#1E90FF',
    mountain: '#808080',
    forest: '#228B22'
  };
  return colors[terrain] || '#CCCCCC';
};

const getResourceColor = (resource: string): string => {
  const colors: { [key: string]: string } = {
    gold: '#FFD700',
    iron: '#A9A9A9',
    horses: '#8B4513',
    food: '#FFA500'
  };
  return colors[resource] || '#FFFFFF';
};

const getUnitIcon = (type: string): string => {
  const icons: { [key: string]: string } = {
    warrior: '‚öîÔ∏è',
    archer: 'üèπ',
    spearman: 'üó°Ô∏è',
    settler: 'üë•',
    builder: 'üèóÔ∏è'
  };
  return icons[type] || '‚ùì';
}; 